<html>

<head>
  <meta charset="utf8" />
  <link rel="stylesheet" href="/css/main.css?20181201" type="text/css" />
</head>

<body style="text-align: left;">
  <details style="margin: 10px;">
    <summary>ツール説明</summary>
    <p>
      FEの人物相関図を簡単に作れるツールです。2人のキャラとその関係を入力すると関係を1つ追加できます。関係は+ボタンで増やす事ができます。
      できた人物相関図は画像として保存できますが、端末によっては正しく保存できないことがあります。邪魔な位置に広告が表示された場合はお手数ですがページのリロードをお願いします。</p>

  </details>
  <div style="clear: both;"></div>
  <style>
    .charOptionSelect {
      width: 220px;

    }

    .editByTextButton {
      background-image: url('/images/720_pe_h.png');
      background-size: contain;
      background-repeat: no-repeat;
      width: 20px;
      height: 20px;
      border-style: none;
      display: inline-block;
    }

    .editByTextButton:hover {
      opacity: 0.5;
    }

    .darken {
      filter: brightness(70%);
    }

    .manualTextbox {
      font-size: 18px;
      width: 220px;
      vertical-align: bottom;
      display: inline-block;
    }

    .topMenuIconButton {
      background-size: contain;
      background-repeat: no-repeat;
      width: 32px;
      height: 32px;
      border-style: none;
      vertical-align: middle;
    }

    .iconButton {
      background-size: contain;
      background-repeat: no-repeat;
      width: 32px;
      height: 32px;
      border-style: none;
    }

    .iconButton:hover {
      opacity: .5;
    }

    .selectableIcon:hover {
      opacity: .5;
    }

    .edgeEditBox {
      position: relative;
      width: 246px;
      height: 130px;
      padding: 5px;
      background-color: #9ccabf;
      margin: 3px;
      display: inline-block;
      border: 2px solid #797;
      border-radius: 10px;
    }

    .edgeEditBoxContainer {
      position: relative;
      padding: 5px;
      margin: 0px;
      display: block;
      border: 2px solid #797;
      border-radius: 10px;
      background-color: rgb(204, 228, 204);
      width: fit-content;
      height: fit-content;
    }
  </style>
  <div id="app" style="text-align: left;">
    <select v-model="graph.layout" style="font-size: 18px;" @change="updateGraphAuto()">
      <option v-for="option in layoutOptions" v-bind:value="option.id">
        {{ option.text }}
      </option>
    </select>
    <select v-model="graph.rankdir" style="font-size: 18px;" @change="updateGraphAuto()" v-if="graph.layout=='dot'">
      <option v-for="option in rankdirOptions" v-bind:value="option.id">
        {{ option.text }}
      </option>
    </select>
    <div style="display: block;position:relative">
      <div>

        <span v-show="isDebugModeEnabled">
          <input type="button" value="図を強制更新" @click="updateGraph();">
          <input id="isAutoUpdateEnabled" v-model="isAutoUpdateEnabled" type="checkbox"><label
            for="isAutoUpdateEnabled">図の自動更新</label>
        </span>
      </div>

      <div id="graph" style="text-align: left;border: 1px solid rgb(220, 220, 220);width:fit-content;position:relative">
        <div style="float:right">
          <div style="display:inline-block">
            <input id="download-btn" type="button" class="topMenuIconButton selectableIcon" value="クリア"
              onclick="g_appData.clearNodes();updateGraphAuto();" style="width: 50px;">
          </div>

          <div style="display:inline-block">
            <input id="download-btn" type="button" class="topMenuIconButton selectableIcon"
              style="background-image: url('/images/download.png');" onclick="saveGraphAsPng()">
          </div>
        </div>
        <div style="clear: both;"></div>
      </div>
      <p>{{message}}</p>
    </div>
    <fieldset class="edgeEditBoxContainer">
      <legend>選択ノード</legend>
      <div v-for="node in selectedNodes">
        <span>
          <select2 :options="titleToCharOptions[currentTitle]" v-model="node.name"
            @input="g_appData.updateNodeInfo(node);updateGraphAuto();" class="charOptionSelect"></select2>
        </span>
        <span v-if="isDebugModeEnabled">
          id={{node.id}}, name={{node.name}}
        </span>
      </div>
    </fieldset>
    <fieldset class="edgeEditBoxContainer">
      <legend>関係の設定</legend>
      作品: <select v-model="currentTitle" style="font-size: 18px;">
        <option v-for="option in titleOptions" v-bind:value="option.id">
          {{ option.text }}
        </option>
      </select>
      <div style="float:right;margin-right: 5px;">
        <input type="button" @click="g_appData.createNewEdge()"
          style="background-image: url('/images/add.png');background-color: rgb(204, 228, 204);width:20px;height:20px"
          class="iconButton" />
      </div>
      <div style="clear: both;"></div>

      <div v-for="value in graph.edges" class="edgeEditBox">
        <div style="position:absolute;top:2px;right:2px;">
          <input type="button" class="iconButton" @click="g_appData.duplicateEdge(value);updateGraphAuto();"
            style="height: 20px;padding: 0;margin:0 6px 0 0;vertical-align: top;" value="複製" />

          <input type="button" @click="g_appData.removeEdge(value);updateGraphAuto();"
            style="width:20px;height:20px;background-image: url('/images/remove.png');background-color: #9ccabf;"
            class="iconButton" />
        </div>

        <div style="margin-top: 20px;">
          <div style="display: inline-block; vertical-align: middle;">
            <span v-if="value.usesSourceText">
              <input type="text" v-model="value.sourceText" class="manualTextbox" @change="updateGraphAuto()" />
            </span>
            <span v-else>
              <select2 :options="titleToCharOptions[currentTitle]" v-model="value.source" @input="updateGraphAuto()"
                class="charOptionSelect"></select2>
            </span>
          </div>
          <div style="display: inline-block; vertical-align: middle;">
            <span v-if="value.usesSourceText">
              <input type="button" class="editByTextButton" @click="value.usesSourceText = !value.usesSourceText;">
            </span>
            <span v-else>
              <input type="button" class="editByTextButton darken"
                @click="value.usesSourceText = !value.usesSourceText;">
            </span>
          </div>
        </div>
        <div style="padding: 3px;">
          <select v-model="value.dir" style="font-size: 18px;" @change="updateGraphAuto()">
            <option v-for="option in dirOptions" v-bind:value="option.id">
              {{ option.text }}
            </option>
          </select>

          <input type="text" v-model="value.label" @change="updateGraphAuto()"
            style="vertical-align:text-bottom;width:170px;">
          <input type="button" @click="g_appData.swapEdgeDirection(value);updateGraphAuto();"
            style="background-image: url('/images/swap.png');width:20px;height:20px" class="iconButton" />
        </div>
        <div>
          <div style="display: inline-block; vertical-align: middle;">

            <span v-if="value.usesDestinationText">
              <input type="text" v-model="value.destinationText" class="manualTextbox" @change="updateGraphAuto()" />
            </span>
            <span v-else>
              <select2 :options="titleToCharOptions[currentTitle]" v-model="value.destination" class="charOptionSelect"
                @input="updateGraphAuto()">
              </select2>
            </span>
          </div>
          <div style="display: inline-block; vertical-align: middle;">

            <span v-if="value.usesDestinationText">
              <input type="button" class="editByTextButton"
                @click="value.usesDestinationText = !value.usesDestinationText;">
            </span>
            <span v-else>
              <input type="button" class="editByTextButton darken"
                @click="value.usesDestinationText = !value.usesDestinationText;">
            </span>
          </div>
        </div>
        <div style="margin-top: 2px;" v-if="graph.layout == 'dot'">
          <label v-bind:for="'rank' + value.id">
            <input v-bind:id="'rank' + value.id" type="checkbox" v-model="value.isRankSame"
              @change="updateGraphAuto();">
            同階層
          </label>
        </div>
        <div style="display: inline-block;background-color: aliceblue;margin: 3px;padding:3px;border: solid 1px #999;"
          v-if="isDebugModeEnabled">
          <div>
            source={{value.source}}, destination={{value.destination}}
          </div>
          <div>
            destinationText="{{value.destinationText}}"
          </div>
        </div>
      </div>
    </fieldset>

    <details>
      <summary>グループの設定</summary>
      <input id="showsCluster" v-model="showsCluster" type="checkbox" @change="updateGraph();"><label
        for="showsCluster">グループを表示する</label>
      <table>
        <tr>
          <th style="padding:0;text-align: left;"><input type="button"
              @click="g_appData.createNewCluster();g_app.$forceUpdate();"
              style="background-image: url('/images/add.png');" class="iconButton" /></th>
          <th>グループ名</th>
          <th>背景色</th>
          <th>所属キャラ</th>
        </tr>
        <tr v-for="cluster in clusters">
          <td style="vertical-align: top;"><input type="button"
              @click="g_appData.removeCluster(cluster);updateGraphAuto();"
              style="background-image: url('/images/remove.png');" class="iconButton" /></td>
          <td style="vertical-align: top;">
            <input type="text" class="manualTextbox" v-model="cluster.label"
              @change="g_appData.syncClusterLabelToOption(cluster);updateGraphAuto()" />
          </td>
          <td style="vertical-align: top;">
            <input type="color" v-model="cluster.color" @change="updateGraphAuto()">
          </td>
          <td style="width: 290px;">
            <input type="button" @click="g_appData.addEmptyNodeToCluster(cluster)"
              style="background-image: url('/images/add.png');" class="iconButton" />

            <div style="float:right">
              <table>
                <tr v-for="node in cluster.belongingNodes">
                  <td>
                    <input type="button" @click="g_appData.removeNodeFromCluster(node, cluster);updateGraphAuto()"
                      style="background-image: url('/images/remove.png');" class="iconButton" />
                  </td>
                  <td>
                    <select2 :options="titleToCharOptions[currentTitle]" v-model="node.name" class="charOptionSelect"
                      @input="updateGraphAuto()">
                    </select2>
                  </td>
                </tr>
              </table>
            </div>
          </td>
        </tr>
      </table>
    </details>



    <p>
    <details open style="padding: 5;" class="detailsDefault">
      <summary>設定の共有</summary>
      以下のURLで設定を再現する事ができます。<br />
      <input type="button" value="コピー" @click="copyUrl()">
      <input type="button" value="このURLをツイート" @click="location.href=g_appData.tweetUrl;">
      <!-- <input type="button" value="インポート" @click="importUrl(g_appData.currentUrl)"> -->
      <br />
      <textarea id="urlTextArea" v-model="exportSettingUrl" style="width: 400px;height: 50px;" readonly></textarea>

    </details>
    </p>
    <p>
    <div v-show="isDebugModeEnabled">
      <fieldset class="edgeEditBoxContainer" style="display: inline-block;">
        <legend>graph.nodes</legend>
        <div v-for="node in graph.nodes">
          <div class="edgeEditBox">
            <div>
              id={{node.id}}, name={{node.name}}
            </div>
            <div>
              displayName={{node.displayName}}
            </div>
            <div>
              pos=({{node.x}}, {{node.y}})
            </div>
          </div>
        </div>
      </fieldset>
      <fieldset class="edgeEditBoxContainer" style="display: inline-block;">
        <legend>displayGraph.nodes</legend>
        <div v-for="node in displayGraph.nodes">
          <div class="edgeEditBox">
            <div>
              id={{node.id}}, name={{node.name}}
            </div>
            <div>
              displayName={{node.displayName}}
            </div>
            <div>
              pos=({{node.x}}, {{node.y}})
            </div>
          </div>
        </div>
      </fieldset>
      <input type="button" value="URL強制インポート" @click="importUrl(g_appData.debugImportUrl, 1)">
      <br />
      <textarea v-model="debugImportUrl" style="width: 600px;height:100px;"></textarea>
      <br />
      ログ:<br />
      <textarea v-model="log" style="width: 600px;height: 300px; "></textarea>
    </div>
    <div>
      <!--キャラ画像確認用-->
      <!-- <div v-for="info in characters" style="display:inline-block; text-align: center;"><img
          v-bind:src="ThumbRoot + info.imageName"><br />{{info.name}}<br />({{info.imageName}})</div> -->
    </div>
    <div style="clear: both;float:right">
      <input id="isDebugModeEnabled" type="checkbox" v-model="isDebugModeEnabled"><label
        for="isDebugModeEnabled">デバッグモード(開発者用)</label>
    </div>
    </p>
  </div>

  <script>
    function findSvgElem() {
      let graphRoot = document.getElementById("graph");
      for (const node of graphRoot.childNodes) {
        if (node.nodeName == "svg") {
          return node;
        }
      }
      return null;
    }
    function saveGraphAsPng() {
      console.log("download button clicked");
      let svgElem = findSvgElem();
      if (svgElem == null) {
        console.error("svg element was not found.");
        return;
      }
      svg2imageData(svgElem, function (data) {
        console.log("creating download url");
        let downloadEle = document.createElement("a");
        downloadEle.href = data;
        downloadEle.download = "FeRelationshipChart.png";
        downloadEle.click();
      }, function (error) {
        console.log(error);
        alert('failed to convert');
      });
    };
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

  <!-- select2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css"
    media="print" onload="this.media='all'">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

  <!-- vue.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.min.js"></script>

  <!-- 文字列圧縮 -->
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"
    integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- <script src="/node_modules/d3/dist/d3.js"></script> -->
  <script src="/node_modules/@hpcc-js/wasm/dist/index.js" type="javascript/worker"></script>
  <script src="/node_modules/d3-graphviz/build/d3-graphviz.js"></script>
  <script src="/js/sql.js/dist/sql-wasm.js"></script>

  <script src="/FehTools/FehRelationshipChartMaker/Graph.js?20230619"></script>
  <script src="/FehTools/FehRelationshipChartMaker/Utilities.js?20231015"></script>
  <script src="/FehTools/FehRelationshipChartMaker/SqliteDatabase.js?20230618_1"></script>
  <script src="/FehTools/FehRelationshipChartMaker/Main.js?20230618_1"></script>
  <script src="/FehTools/FehRelationshipChartMaker/Main_OriginalChar.js?20230618_1"></script>

  <script>
    window.addEventListener('load', (event) => {
      initMain(null);
      g_appData.showsCluster = true;
    });
  </script>
</body>

</html>